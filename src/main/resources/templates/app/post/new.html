<!DOCTYPE html>
<body xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/app}">
<div layout:fragment="content" class="main-content">
    <h1>게시물 작성</h1>
    <hr>
    <form id="post-form" th:action="@{/post}" method="POST" th:object="${postDto}">
        <input id="fileId" type="hidden" th:field="*{file.name}">
        <input id="filePath" type="hidden" th:field="*{file.path}">
        <input id="fileExt" type="hidden" th:field="*{file.ext}">

        <div class="row mb-3">
            <label for="title" class="col-sm-1 col-form-label">제목</label>
            <div class="col-sm-11">
                <input type="text" class="form-control bg-white" id="title" th:field="*{title}">
            </div>
        </div>
        <div class="row mb-3">
            <label for="summernote" class="col-sm-1 col-form-label">내용</label>
            <div class="col-sm-11">
                <textarea class="form-control bg-white shadow" id="summernote" th:field="*{content}"></textarea>
            </div>
        </div>
    </form>

    <form id="file-form" method="POST" enctype="multipart/form-data" th:action="@{/files}" class="mb-3">
        <div class="row">
            <label for="files" class="col-sm-1 col-form-label">첨부 파일</label>
            <div class="col-sm-11">
                <input class="form-control bg-white" type="file" id="files" name="files" multiple>
            </div>
        </div>
    </form>


    <div class="mt-3 d-flex justify-content-between">
        <a th:href="@{/}" class="btn btn-secondary"><- 홈으로</a>
        <button type="button" class="btn btn-outline-success save-btn">저장</button>
    </div>


</div>
<th:block layout:fragment="script">
    <script th:src="@{/node_modules/summernote/dist/summernote-bs5.js}"></script>
    <script type="application/javascript">
        document.addEventListener("DOMContentLoaded", () => {
            $('#summernote').summernote({
                placeholder: '게시물 내용을 입력해주세요.',
                tabsize: 2,
                lang: "ko-KR",
                height: 300,
                callbacks: {	//여기 부분이 이미지를 첨부하는 부분
                    onImageUpload : function(files) {
                        uploadSummernoteImageFile(files[0],this);
                    },
                    onPaste: function (e) {
                        const clipboardData = e.originalEvent.clipboardData;
                        if (clipboardData && clipboardData.items && clipboardData.items.length) {
                            const item = clipboardData.items[0];
                            if (item.kind === 'file' && item.type.indexOf('image/') !== -1) {
                                e.preventDefault();
                            }
                        }
                    }
                }
            });

            const saveButton = document.querySelector(".save-btn");
            saveButton.addEventListener("click", upload);

        })

        /**
         * 이미지 파일 업로드
         */
        function uploadSummernoteImageFile(file, editor) {
            const token = $("meta[name='_csrf']").attr("content");
            const header = $("meta[name='_csrf_header']").attr("content");
            const data = new FormData();
            data.append("file", file);
            $.ajax({
                data : data,
                beforeSend : function(xhr) {
                    xhr.setRequestHeader(header, token);
                },
                type : "POST",
                url : "/uploadSummernoteImageFile",
                contentType : false,
                processData : false,
                success : function(data) {
                    //항상 업로드된 파일의 url이 있어야 한다.
                    $(editor).summernote('insertImage', data.url);

                    setFileInfo(data);
                }
            });
        }

        function setFileInfo(info) {
            const nameInput = document.getElementById("fileId");
            const pathInput = document.getElementById("filePath");
            const extInput = document.getElementById("fileExt");

            nameInput.value = info.name;
            pathInput.value = info.path;
            extInput.value = info.ext;
        }

        function upload() {

            const token = document.querySelector('meta[name="_csrf"]').content;
            const header = document.querySelector('meta[name="_csrf_header"]').content;

            const form = document.getElementById("file-form");
            const data = new FormData(form);

            $.ajax({
                url: '/files/upload',
                type: "POST",
                async: false,
                enctype: 'multipart/form-data',
                contentType: false,
                processData: false,
                data : data,
                beforeSend : function(xhr) {
                    xhr.setRequestHeader(header, token);
                },
                success: function (result) {
                    console.log(result)
                    alert("success")
                },
                error: function (e) {
                    alert("fail")
                }
            });
        }

    </script>
</th:block>
</body>